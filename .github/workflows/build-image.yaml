name: Build image

on:
  workflow_call:
    inputs:
      username:
        required: true
        type: string
      image-name:
        required: true
        type: string
      branch-name:
        required: true
        type: string

jobs:
  build-image:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ inputs.username }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Find image tagged with branch name
        run: |
          id=$(curl -s -L -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }} \
           "https://api.github.com/orgs/bp3/packages/container/wm-extract-deploy/versions" \
            | jq -r ".[] | select(.metadata.container.tags) | index(\"${{ inputs.branch-name }}\") | .id")
          if [ "$id" != "" ]; then
            curl -s -L -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/orgs/bp3/packages/container/wm-extract-deploy/versions/$id"
          fi

      - name: Build Docker image of application
        run: |
          docker build -t ${{ inputs.image-name }}:${{ inputs.branch-name }} .

      - name: Push to local registry
        run: |
          docker push ${{ inputs.image-name }}:${{ inputs.branch-name }}
